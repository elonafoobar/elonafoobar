

    <!doctype html>
    <html class="no-js" lang="">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>readme.md topic</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../uikit.min.css" type="text/css" />
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
    </head>
    <body>

    <div class="uk-container uk-container-center">
    <div class="uk-grid uk-margin-top">

    <img src="../red_putit.png" alt="Lua API" class="icon">

    <!-- sidebar start -->
    <aside class="uk-width-medium-1-5 uk-row-first">
    <div id="sidebar" class="uk-panel">

    <div class="sidebar-custom">

    <div class="project-infobox">

    <!-- project title -->

    <a href="../index.html"><h1 style="padding-top: 8px">Lua API</h1></a>

    <!-- project description -->
    <p class="project-desc">Elona foobar Mod API</p>

    <!-- project full description -->
    <span>  Core API for modding Elona foobar</span>
    </div>


    <!-- sidebar navigation -->
    <ul class="uk-nav">
    <li class="nav-item">
    <h2 class="uk-panel-title">Topics</h2>
    <ul class="nav">
    <li class="nav-item active"><div class="nav-item-block-active block"><a href="../topics/readme.md.html"><span class="module-name-item">readme.md</span></a><i class="icon icon-arrow-left icon-arrow-left-custom"></i></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../topics/i18n.md.html"><span class="module-name-item">i18n.md</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../topics/i18n_functions.md.html"><span class="module-name-item">i18n_functions.md</span></a></div></li>
    </ul>
    </li>
    </ul>
    <ul class="uk-nav">
    <li class="nav-item">
    <h2 class="uk-panel-title">Modules</h2>
    <ul class="nav">
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/Animation.html"><span class="module-name-item">Animation</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/Chara.html"><span class="module-name-item">Chara</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/Debug.html"><span class="module-name-item">Debug</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/Enums.html"><span class="module-name-item">Enums</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/Event.html"><span class="module-name-item">Event</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/Event.EventKind.html"><span class="module-name-item">Event.EventKind</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/FOV.html"><span class="module-name-item">FOV</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/GUI.html"><span class="module-name-item">GUI</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/I18N.html"><span class="module-name-item">I18N</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/Input.html"><span class="module-name-item">Input</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/Item.html"><span class="module-name-item">Item</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/Iter.html"><span class="module-name-item">Iter</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/Magic.html"><span class="module-name-item">Magic</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/Map.html"><span class="module-name-item">Map</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/Math.html"><span class="module-name-item">Math</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/Pos.html"><span class="module-name-item">Pos</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/Rand.html"><span class="module-name-item">Rand</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/Registry.html"><span class="module-name-item">Registry</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/Skill.html"><span class="module-name-item">Skill</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/Trait.html"><span class="module-name-item">Trait</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../modules/World.html"><span class="module-name-item">World</span></a></div></li>
    </ul>
    </li>
    </ul>
    <ul class="uk-nav">
    <li class="nav-item">
    <h2 class="uk-panel-title">Classes</h2>
    <ul class="nav">
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../classes/LuaCharacter.html"><span class="module-name-item">LuaCharacter</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../classes/LuaItem.html"><span class="module-name-item">LuaItem</span></a></div></li>
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../classes/LuaPosition.html"><span class="module-name-item">LuaPosition</span></a></div></li>
    </ul>
    </li>
    </ul>
    <ul class="uk-nav">
    <li class="nav-item">
    <h2 class="uk-panel-title">Examples</h2>
    <ul class="nav">
    <li class="nav-item"><div class="nav-item-block-inactive block"><a href="../examples/life.lua.html"><span class="module-name-item">life.lua</span></a></div></li>
    </ul>
    </li>
    </ul>



    <!-- list of items in a module -->
    </div>
    </div>
    </aside>
    <!-- sidebar end -->

    <!-- content body start -->
    <div class="uk-width-medium-4-5 uk-push-1">

    <!-- module list on the main page start -->
    <!-- module list on the main page end -->

    <!-- module contents -->

    <!-- module content header start -->

    <h2><span class="body-module-name"><strong><em>readme.md</em></strong></span> topic</h2>
    <p></p>
    <p></p>




<h1>Lua API</h1>


<p>Welcome traveler! This is the documentation for the Elona foobar mod API.</p>



<p>Before proceeding, <strong>please note</strong> that the API will almost certainly undergo substantial changes before it is stabilized. If you write anything with the API, expect that it <strong>will</strong> break sometime in the future, until all the serious design/implementation issues and bugs have been worked out.</p>



<p><a name="Testing_it_out"></a></p>


<h2>Testing it out</h2>


<p>You can run a script at startup by adding a parameter to your <code>config.json</code>. Copy the <code>life.lua</code> example into your <code>data/script</code> folder, and add this line to your <code>config.json</code>:</p>



<pre><code> "startup_script": "life.lua"
</code></pre>


<p>Starting the game will place you in a script testing map, isolated from your other saves. There you can see the script in action. The <code>life.lua</code> script will run Conway's Game of Life by setting tiles in the map. Let's break down how it works.</p>



<h3>Module requires</h3>



<pre><code> local Map = Elona.require("Map")
 local Enums = Elona.require("Enums")
 local Event = Elona.require("Event")
 local Rand = Elona.require("Rand")
</code></pre>


<p>At the top, we have some defines. All modules related to the core API can be obtained by using <code>Elona.require</code>.</p>



<h3>Grid setup</h3>



<pre><code> local function create_life_grid()
    local grid = {}
    for i = 1, Map.width() do
       grid[i] = {}

       for j = 1, Map.height() do
          grid[i][j] = Rand.rnd(2)
       end
    end
    return grid
 end
</code></pre>


<p>This function will return a new grid for our life simulation. We will use this for setting up the life grid inside our global storage table if it doesn't already exist.</p>



<h3>Logic</h3>



<pre><code> local function evolve(cell)
 -- ...
 end
</code></pre>


<p>This function runs the life simulation. We won't go into the details, but if you're interested you can see <a href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life">this article</a>.</p>



<pre><code> local function run_life()
    if not Map.is_overworld() then
       local grid = Store.map_local.grid
       if grid == nil then
          Store.map_local.grid = create_life_grid()
          grid = Store.map_local.grid
       end
       for y = 1, Map.width() do
          for x = 1, Map.height() do
             local tile
             if Store.map_local.grid[x][y] == 1 and Map.can_access(x, y) then
                tile = Map.generate_tile("Wall")
             else
                tile = Map.generate_tile("Room")
             end
             Map.set_tile(x, y, tile)
             Map.set_tile_memory(x, y, tile)
          end
       end
       Store.map_local.grid = evolve(grid)
    end
 end
</code></pre>


<p>Here is the main part of the script. This function updates the game map based on the data we stored. Let's go into detail what it does.</p>



<pre><code>    if not Map.is_overworld() then
        -- ...
    end
</code></pre>


<p>First we need to check if we're traveling in the overworld, where setting tiles on the map wouldn't make sense.</p>



<pre><code>       local grid = Store.map_local.grid
       if grid == nil then
          Store.map_local.grid = create_life_grid()
          grid = Store.map_local.grid
       end
</code></pre>


<p>The table <code>Store</code> is for keeping any data we need inside our script.
- <code>Store.map_local</code> holds data that is only relevant to the current map. When the map is changed, it is cleared.
- <code>Store.global</code> holds data that persists throughout the entire game session.</p>



<p>In this case, we store the state of our life grid in <code>map_local</code>. This state will be preserved between subsequent calls to <code>run_life</code> and will be cleaned up when the map is exited. We also check if the store doesn't have our grid and create it if so.</p>



<pre><code>       for y = 1, Map.width() do
          for x = 1, Map.height() do
          -- ...
          end
       end
</code></pre>


<p>Next we iterate over every x-y pair in the map. Since there is only ever one map loaded at a time, we can call <code>Map.width</code> and <code>Map.height</code> without passing in anything.</p>



<pre><code>             local tile
             if Store.map_local.grid[x][y] == 1 and Map.can_access(x, y) then
                tile = Map.generate_tile(Enums.TileKind.Wall)
             else
                tile = Map.generate_tile(Enums.TileKind.Room)
             end
             Map.set_tile(x, y, tile)
             Map.set_tile_memory(x, y, tile)
</code></pre>


<p>Here is where we make use of the <code>Map</code> module to modify the map. You can read the documentation for <code>Map.can_access</code>, <code>Map.generate_tile</code> and <code>Map.set_tile</code> elsewhere in the docs. Essentially, if the simulation reports a cell with value 1, we set that square to a wall tile, else to a floor tile. We also make sure to set the player's memory of that tile so they can see it even if it's out of field of view.</p>



<p>We also use the enum type <code>TileKind</code> here. Some functions take enums to denote one of several different states an object can be in, like the curse state of an object (<code>Blessed</code>, <code>None</code>, <code>Cursed</code>, or <code>Doomed</code>). These will typically be found inside the <code>Enum</code> module. You also can pass the name of the enum itself without using the <code>Enums</code> table (like <code>Map.generate_tile("Wall")</code>), to avoid having to <code>require</code> <code>Enums</code> all the time.</p>



<pre><code>       Store.map_local.grid = evolve(grid)
</code></pre>


<p>Lastly, we call our logic function to update the state of our life grid.</p>



<h3>Events</h3>



<pre><code> Event.register(Event.EventKind.MapInitialized, run_life)
 Event.register(Event.EventKind.AllTurnsFinished, run_life)
</code></pre>


<p>Finally, this is the most critical part of the script: hooking it up so it can be ran in response to in-game events. The <code>Event.register</code> function will set up a function you provide to be called when an in-game event is fired. In this case, we want to run our function <code>run_life</code> when the map is first loaded and every time all characters in the map have finished moving. There are various kinds of events you can listen for, and they are listed in the documentation for <code>Defines.EventKind</code>.</p>



<p>That's all for this tutorial. Go forth and find game-breaking bugs! (and preferably report them to us)</p>




    <!-- module info start -->
    <!-- module info end -->

    <!-- module usage start -->
    <!-- module usage end -->

    <!-- module content header end -->

    <!-- module section list start -->
    <!-- module section list end -->

    <br />

    <!-- section start -->

    </div>

    <!-- section end -->

    </div>
    </div>
    </div>

    <div class="uk-container uk-container-center uk-hidden-small">
    <hr/>
    <div class="footer-columns columns">
    <div class="sidebar-footer column col-3 col-sm-12">
    <i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.6</a></i>
    </div>
    <div class="content-footer column col-9 col-sm-12">
    <i>Last updated 2019-01-12 UTC</i>
    </div>
    </div>
    </div>
    </body>
    </html>
